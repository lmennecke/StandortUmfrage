<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Standorte auf Deutschlandkarte</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    #map { height: 65vh; width: 65vw; }
    #info { padding: 20px; }
  </style>
</head>
<body>
  <h2 style="text-align:center;">Gib Deinen Spielernamen an</h2>
  <div style="text-align:center; margin-bottom:10px;">
     <label>Spielername: 
       <input type="text" id="spielerName" placeholder="z.B. Runner" required />
     </label>
  </div>
  <div style="text-align:center; margin-bottom:10px;">
  <label>Welche Spiele spielst du? 
    <select id="spiele" required>
      <option value="">Bitte wählen</option>
      <option value="AM">AM</option>
      <option value="SSM">SSM</option>
      <option value="AM und SSM">AM und SSM</option>
    </select>
  </label>
</div>
  <h2 style="text-align:center;">Klicke deinen Standort ungefähr an</h2>
  <div id="map"></div>
  <div style="text-align:center; margin: 10px;">
     <label>Filter: 
        <select id="filterSpiele">
          <option value="AM und SSM">AM & SSM</option>
          <option value="AM">AM</option>
          <option value="SSM">SSM</option>
        </select>
    </label>
  </div>
  <div id="info">Letzter Klick: <span id="coords">-</span></div>
  <!-- Statusanzeige -->
  <div id="status">
    Status: <span id="statustxt">Bereit</span>
  </div>
  <div id="debug" style="white-space: pre-wrap; font-family: monospace; background:#eee; padding:10px;"></div>

  <form id="hiddenForm" 
     action="https://docs.google.com/forms/d/1eHl86G0vzQkdx3YN1_4zrKQWyQ1QRoSoCFRkYPwIpBw/formResponse" 
     method="POST"
     style="display:none">
     <input type="text" name="entry.1438475443" id="inputCoords">
     <input type="text" name="entry.403967903" id="inputName">
  </form>
<iframe name="hidden_iframe" style="display:none"></iframe>

  <script>
    const sheetID = '1FWJ4wITDLekDidgoVY2h64EmPjPV1Ee-IOz8tDI1c0s'; // <- hier einfügen!
    //const sheetID = '2PACX-1vRT2iW41YnR4vNE_g_HpA12YpSTEM5A5lcELnwiLsCqRjhf-IWVs2BC09tdPSW2tt2o1ugztE2_vhri'
    const csvURL = `https://docs.google.com/spreadsheets/d/${sheetID}/export?format=csv`;
    const formURL = 'https://docs.google.com/forms/d/1eHl86G0vzQkdx3YN1_4zrKQWyQ1QRoSoCFRkYPwIpBw/formResponse'; // <- hier einfügen!
    const formAppURL = 'https://script.google.com/macros/s/AKfycby3AedcVo8YrkxT-7s8r9ka7JacEhP405wbMGeOF06uR-6EYCpt7jXM8yOozWabRP76/exec';
    const coordsField = 'entry.1438475443'; // <- ersetzen durch deine Feld-ID
    const nameField = 'entry.403967903'; // ← Ersetze mit der Google Form-Feld-ID für „Spielername“
    const gameField = 'entry.1647833182';

    const map = L.map('map').setView([51.1657, 10.4515], 6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    const markerGroup = L.layerGroup().addTo(map);  // Marker-Gruppe für Reset

loadData(); // Erste Ladung
setInterval(loadData, 20000); // Alle 60 Sekunden neu laden
document.getElementById('filterSpiele').addEventListener('change', loadData);

    let marker;
map.on('click', function(e) {
  const nameField = document.getElementById('spielerName');
if (!nameField || !nameField.value.trim()) {
  alert("Bitte gib zuerst einen Spielernamen ein.");
  document.getElementById('statustxt').textContent = 'Fehlender Spielername';
  return;
}
const nameInput = nameField.value.trim();
  const spielAuswahlField = document.getElementById('spiele')
  if (!spielAuswahlField || !spielAuswahlField.value.trim()) {
     alert("Bitte wähle ein Spiel aus.");
     document.getElementById('statustxt').textContent = 'Fehlende Spieleauswahl';
     return;
  }
  const spielAuswahl = spielAuswahlField.value.trim();  
  
  const latlng = e.latlng;

  if (marker) {
    marker.setLatLng(latlng);
  } else {
    marker = L.marker(latlng).addTo(map);
  }

  document.getElementById('coords').textContent =
    latlng.lat.toFixed(4) + ", " + latlng.lng.toFixed(4);

  //const nameInput = document.getElementById('spielerName').value.trim();

  //if (!nameInput) {
  //  alert("Bitte gib zuerst einen Spielernamen ein.");
  //  document.getElementById('statustxt').textContent = 'Fehlender Spielername';
  //  return;
  //}

  //const data = new FormData();
  //data.append(coordsField, latlng.lat + ',' + latlng.lng);
  //data.append(nameField, nameInput);
  //data.append(gameField, spielAuswahl); // ← spieleField muss vorher definiert sein
  
  const data = new URLSearchParams();
  data.append('spielername', nameInput);
  data.append('coords', latlng.lat + ',' + latlng.lng);
  data.append('spiele', spielAuswahl);

  document.getElementById('statustxt').textContent = 'Sende…';

  fetch(formAppURL, {
    method: 'POST',
    //mode: 'no-cors',
    body: data
  }).then(() => {
    document.getElementById('statustxt').textContent = 'Erledigt ✓';
    loadData()
    setTimeout(() => {
      document.getElementById('statustxt').textContent = 'Bereit';
    }, 3000);
  }).catch(() => {
    document.getElementById('statustxt').textContent = 'Fehler beim Senden';
  });
});


  function parseCSV(csvText) {
     const parsed = Papa.parse(csvText, {
       header: true,              // Uses first row as keys
       skipEmptyLines: true,      // Ignore blank rows
       dynamicTyping: false       // Keeps everything as strings
     });

     if (parsed.errors.length > 0) {
       document.getElementById('debug').textContent += 
         '⚠️ CSV Parsing Error: ' + JSON.stringify(parsed.errors, null, 2);
     }

     return parsed.data;
  }
    
    function loadData() {
  fetch(csvURL)
    .then(res => res.text())
    .then(csvText => {
      document.getElementById('debug').textContent = "CSV geladen:\n" + csvText;
      const entries = parseCSV(csvText);
      document.getElementById('debug').textContent += "\n\nGeparst:\n" + JSON.stringify(entries, null, 2);
      const filter = document.getElementById('filterSpiele').value;
      
      // Karte leeren (nur Marker löschen)
      markerGroup.clearLayers();

      entries.forEach(entry => {
        if (entry.StandortKoordinaten) {
          const [lat, lng] = entry.StandortKoordinaten.split(',').map(Number);
          const name = entry.Spielername|| 'Ohne Name';
          const currentName = document.getElementById('spielerName').value.trim();
          const isCurrentUser = (name === currentName);
          //const marker = L.marker([lat, lng]).bindPopup(name);
          const spiele = entry.SpielAuswahl || '';
          if ((!filter || filter === spiele) || spiele === 'AM und SSM' || filter === 'AM und SSM' || isCurrentUser) {
             let color = 'gray';
             if (spiele === 'AM') color = 'blue';
             else if (spiele === 'SSM') color = 'orange';
             else if (spiele === 'AM und SSM') color = 'green';
             const marker = L.circleMarker([lat, lng], {
                radius: 6,
                weight: 9,
                color: isCurrentUser ? 'red' : color,
                opacity: isCurrentUser ? 0.6 : 0.3,
                fillColor: color,
                fillOpacity: 0.8
             }).bindPopup(name);
             markerGroup.addLayer(marker);
          }
        }
      });
    })
    .catch(err => {
      //console.error("Fehler beim Laden der Daten:", err)
      document.getElementById('debug').textContent += "\n\nFehler beim Laden:\n" + err;
    });
}

  </script>
  
</body>
</html>
